#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

if ! command -v docker >/dev/null 2>&1; then
  echo "docker is required" >&2
  exit 1
fi

if ! docker compose version >/dev/null 2>&1; then
  echo "docker compose is required" >&2
  exit 1
fi

OUT_DIR="${ROOT_DIR}/backups"
mkdir -p "$OUT_DIR"

STAMP="$(date +%Y%m%d-%H%M%S)"
OUT_FILE="${1:-${OUT_DIR}/tailshell-${STAMP}.sql.gz}"

echo "Creating backup: ${OUT_FILE}"

docker compose exec -T mysql sh -lc 'mysqldump -uroot -p"$MYSQL_ROOT_PASSWORD" --single-transaction --quick --routines --events --triggers --no-tablespaces Tailshell' \
  | gzip -c >"$OUT_FILE"

echo "Backup complete: ${OUT_FILE}"

