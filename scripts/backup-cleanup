#!/usr/bin/env bash
# Clean up old backups (keep last 7 days)
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BACKUP_DIR="${ROOT_DIR}/backups"
KEEP_DAYS="${TAILSHELL_BACKUP_KEEP_DAYS:-7}"

if [ ! -d "$BACKUP_DIR" ]; then
  echo "Backup directory does not exist: $BACKUP_DIR"
  exit 0
fi

echo "Cleaning up backups older than ${KEEP_DAYS} days in ${BACKUP_DIR}"

# Find and delete old backup files
count=0
while IFS= read -r -d '' file; do
  echo "Removing old backup: $file"
  rm -f "$file"
  ((count++)) || true
done < <(find "$BACKUP_DIR" -name "tailshell-*.sql.gz" -type f -mtime +${KEEP_DAYS} -print0 2>/dev/null)

if [ "$count" -eq 0 ]; then
  echo "No old backups to clean up."
else
  echo "Removed $count old backup(s)."
fi

# Show remaining backups
remaining=$(find "$BACKUP_DIR" -name "tailshell-*.sql.gz" -type f 2>/dev/null | wc -l)
echo "Remaining backups: $remaining"
