load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    etag on;

    # Logging (stdout/stderr for Docker)
    # Avoid leaking one-time tokens in logs by sanitizing known sensitive paths.
    map $uri $log_uri {
        default $uri;
        ~^/api/invites/[^/]+$ /api/invites/[token];
        ~^/api/invites/[^/]+/accept$ /api/invites/[token]/accept;
        ~^/api/password-resets/[^/]+$ /api/password-resets/[token];
    }

    log_format main_json escape=json
        '{'
          '"ts":"$time_iso8601",'
          '"remote":"$remote_addr",'
          '"xff":"$http_x_forwarded_for",'
          '"method":"$request_method",'
          '"uri":"$log_uri",'
          '"status":$status,'
          '"bytes":$body_bytes_sent,'
          '"request_time":$request_time,'
          '"upstream_addr":"$upstream_addr",'
          '"upstream_status":"$upstream_status",'
          '"upstream_time":"$upstream_response_time",'
          '"client_request_id":"$http_x_request_id",'
          '"upstream_request_id":"$upstream_http_x_request_id",'
          '"user_agent":"$http_user_agent"'
        '}';

    access_log /dev/stdout main_json;
    error_log /dev/stderr warn;

    # Compression (best-effort: brotli when supported, gzip fallback)
    brotli on;
    brotli_comp_level 5;
    brotli_static on;
    brotli_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;

    gzip on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_vary on;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;

    upstream api {
        server api:3000;
        keepalive 32;
    }

    upstream ttyd {
        server host.docker.internal:7681 max_fails=3 fail_timeout=10s;
        keepalive 8;
    }

    server {
        listen 80;
        server_name _;

        # If nginx is reached over HTTPS (e.g., Tailscale Serve), HSTS will be honored by browsers.
        add_header Strict-Transport-Security "max-age=31536000" always;

        # Baseline security headers (locations that set their own add_header must repeat these).
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;

        # Always emit relative redirects (important when TLS is terminated upstream).
        absolute_redirect off;

        root /usr/share/nginx/html;

        # Capture user identity from auth_request for per-user terminal isolation.
        # Values are sourced from response headers returned by /api/auth/validate.
        auth_request_set $tailshell_user_id $upstream_http_x_tailshell_user_id;
        auth_request_set $tailshell_username $upstream_http_x_tailshell_username;
        auth_request_set $tailshell_role $upstream_http_x_tailshell_role;
        auth_request_set $tailshell_session_id $upstream_http_x_tailshell_session_id;
        auth_request_set $tailshell_terminal_arg $upstream_http_x_tailshell_terminal_arg;

        # API routes (no auth required - API handles its own auth)
        location /api/ {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id $http_x_request_id;
            proxy_connect_timeout 3s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
            proxy_buffering on;
            proxy_buffer_size 16k;
            proxy_buffers 64 16k;
            proxy_busy_buffers_size 64k;
            add_header X-Request-Id $upstream_http_x_request_id always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Auth validation subrequest
        location = /auth/validate {
            internal;
            proxy_pass http://api/api/auth/validate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id $http_x_request_id;
            proxy_connect_timeout 2s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 5s;
        }

        # Terminal auth validation subrequest
        location = /auth/terminal {
            internal;
            proxy_pass http://api/api/terminal/validate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-Id $http_x_request_id;
            proxy_connect_timeout 2s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 5s;
        }

        # Login page (no auth required)
        location = /login {
            # Clear any cached Basic Auth by sending 200 without WWW-Authenticate
            auth_basic off;
            try_files /login.html =404;
            add_header Cache-Control "no-store" always;
            add_header Content-Security-Policy "default-src 'none'; script-src 'self' https://challenges.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://challenges.cloudflare.com; img-src 'self' data:; font-src 'self'; frame-src https://challenges.cloudflare.com; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Icons (avoid auth redirects that can confuse browsers)
        location = /favicon.ico {
            auth_basic off;
            return 204;
        }

        # Container health check (no auth)
        location = /healthz {
            auth_basic off;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            return 200 "ok\n";
        }

        location = /favicon.svg {
            auth_basic off;
            try_files /favicon.svg =404;
            add_header Cache-Control "public, max-age=86400" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /login.js {
            auth_basic off;
            try_files /login.js =404;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /login.css {
            auth_basic off;
            try_files /login.css =404;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Password rotation page (used when bootstrap requires rotation)
        location = /change-password {
            auth_basic off;
            try_files /change-password.html =404;
            add_header Cache-Control "no-store" always;
            add_header Content-Security-Policy "default-src 'none'; script-src 'self'; style-src 'self'; connect-src 'self'; img-src 'self' data:; font-src 'self'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /change-password.js {
            auth_basic off;
            try_files /change-password.js =404;
        }

        location = /change-password.css {
            auth_basic off;
            try_files /change-password.css =404;
        }

        # Invite acceptance page (new user registration)
        location = /invite {
            auth_basic off;
            try_files /invite.html =404;
            add_header Cache-Control "no-store" always;
            add_header Content-Security-Policy "default-src 'none'; script-src 'self'; style-src 'self'; connect-src 'self'; img-src 'self' data:; font-src 'self'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /invite.js {
            auth_basic off;
            try_files /invite.js =404;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /invite.css {
            auth_basic off;
            try_files /invite.css =404;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Password reset page (admin-issued reset token)
        location = /reset-password {
            auth_basic off;
            try_files /reset-password.html =404;
            add_header Cache-Control "no-store" always;
            add_header Content-Security-Policy "default-src 'none'; script-src 'self'; style-src 'self'; connect-src 'self'; img-src 'self' data:; font-src 'self'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /reset-password.js {
            auth_basic off;
            try_files /reset-password.js =404;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        location = /reset-password.css {
            auth_basic off;
            try_files /reset-password.css =404;
            add_header Cache-Control "no-store" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Logout - clear cookie and redirect to login
        location = /logout {
            set $tailshell_cookie_secure "";
            if ($scheme = https) {
                set $tailshell_cookie_secure "; Secure";
            }
            if ($http_x_forwarded_proto = https) {
                set $tailshell_cookie_secure "; Secure";
            }
            add_header Set-Cookie "auth_token=; Path=/; Max-Age=0; HttpOnly; SameSite=Strict$tailshell_cookie_secure" always;
            add_header Set-Cookie "terminal_token=; Path=/; Max-Age=0; HttpOnly; SameSite=Strict$tailshell_cookie_secure" always;
            add_header Set-Cookie "refresh_token=; Path=/; Max-Age=0; HttpOnly; SameSite=Strict$tailshell_cookie_secure" always;
            add_header Set-Cookie "refresh_session=; Path=/; Max-Age=0; HttpOnly; SameSite=Strict$tailshell_cookie_secure" always;
            add_header Set-Cookie "csrf_token=; Path=/; Max-Age=0; SameSite=Strict$tailshell_cookie_secure" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            return 302 /login;
        }

        # ttyd WebSocket
        location /ws {
            auth_request /auth/terminal;
            error_page 401 = @login_redirect;
            error_page 403 = @password_redirect;
            error_page 502 503 504 = @terminal_unavailable;

            proxy_pass http://ttyd/ws?arg=$tailshell_terminal_arg;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header Authorization "";
            proxy_connect_timeout 3s;
            proxy_send_timeout 60s;
            proxy_read_timeout 86400;
            proxy_next_upstream error timeout;
        }

        # ttyd token endpoint
        location /token {
            auth_request /auth/terminal;
            error_page 401 = @login_redirect;
            error_page 403 = @password_redirect;
            error_page 502 503 504 = @terminal_unavailable;
            proxy_pass http://ttyd/token?arg=$tailshell_terminal_arg;
            proxy_set_header Authorization "";
            proxy_connect_timeout 3s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            proxy_next_upstream error timeout;
        }

        # UI assets (cacheable, hashed)
        location ^~ /assets/ {
            auth_basic off;
            try_files $uri =404;
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Terminal fallback (ttyd's own UI)
        location = /terminal {
            auth_request /auth/terminal;
            error_page 401 = @login_redirect;
            error_page 403 = @password_redirect;
            proxy_pass http://ttyd/?arg=$tailshell_terminal_arg;
            proxy_set_header Host $host;
            proxy_set_header Authorization "";
            proxy_connect_timeout 3s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Main UI (SPA)
        location / {
            auth_request /auth/validate;
            error_page 401 = @login_redirect;
            error_page 403 = @password_redirect;

            try_files $uri $uri/ /index.html;
            # Avoid stale UI bundles when index.html is cached.
            add_header Cache-Control "no-store, max-age=0" always;
            add_header Content-Security-Policy "default-src 'self'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; object-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' ws: wss:; upgrade-insecure-requests" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
        }

        # Redirect to login on auth failure
        location @login_redirect {
            return 302 /login;
        }

        # Redirect to password rotation when required
        location @password_redirect {
            return 302 /change-password;
        }

        # Terminal service unavailable (ttyd down)
        location @terminal_unavailable {
            default_type application/json;
            return 503 '{"error":"Terminal service temporarily unavailable","code":"TERMINAL_UNAVAILABLE"}';
        }
    }
}
